#!/usr/bin/env coffee

require('coffee-script')

app = require('../app')
debug = require('debug')('lyricscreen:server')
http = require('http')

normalizePort = (val) ->
  port = parseInt(val, 10)

  if isNaN port
    return val

  if port >= 0
    return port

  false

onError = (error) ->
  if error.syscall != 'listen'
    throw error

  bind = typeof port == 'string' ? 'Pipe ' + port : 'Port ' + port

  switch error.code
    when 'EACCES'
      console.error(bind + ' requires elevated privileges')
      process.exit 1
    when 'EADDRINUSE'
      console.error(bind + ' is already in use')
      process.exit 1
    else
      throw error

onListening = () ->
  addr = server.address()
  bind = typeof addr == 'string' ? 'pipe ' + addr : 'port ' + addr.port
  debug('Listening on ' + bind)

port = normalizePort(process.env.PORT || '3000')
app.set('port', port)

server = http.createServer(app)

server.listen port
server.on('error', onError)
server.on('listening', onListening)

